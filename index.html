<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>WhatsApp Cloud API Signup</title>
</head>
<body>
  <button onclick="startWhatsAppSignup()">Start WhatsApp Setup Wizard</button>
  <div id="output" style="margin-top:20px; font-family:Arial;"></div>

  <script src="https://connect.facebook.net/en_US/sdk.js"></script>
  <script>
    const APP_ID = '6673587296096434';
    const CONFIG_ID = '168882059638822';
    const REDIRECT_URI = 'https://cloudapi.srlines.net';
    const BACKEND_URL = 'https://waba-exchange-863732001414.us-central1.run.app/exchange_code';

    window.fbAsyncInit = function() {
      FB.init({ appId: APP_ID, cookie: true, xfbml: false, version: 'v22.0' });
      console.log('FB SDK Initialized');
    };

    function startWhatsAppSignup() {
      console.log('Starting WhatsApp Embedded Signup Wizard...');
      FB.login(function(response) {
        console.log('FB.login Response:', response);
        const code = response.authResponse?.code;
        if (!code) return alert('No OAuth code returned by Facebook');

        console.log('OAuth Code received from Facebook:', code);
        fetch(BACKEND_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ code: code })
        })
        .then(res => res.json())
        .then(data => {
          console.log('Backend Response:', data);
          document.getElementById('output').innerHTML = `
            <p><strong>Business Account ID:</strong> ${data.business_account_id}</p>
            <p><strong>WABA ID:</strong> ${data.waba_id}</p>
            <p><strong>Phone ID:</strong> ${data.phone_id}</p>
            <p><strong>Access Token:</strong> <input value="${data.access_token}" readonly></p>
            <p><strong>App ID:</strong> ${data.app_id}</p>
            <p><strong>Name:</strong> ${data.name}</p>
            <p><strong>Status:</strong> ${data.status}</p>
          `;
        })
        .catch(err => {
          console.error('Backend error:', err);
          document.getElementById('output').innerHTML = '<p style="color:red;">Error fetching data from backend.</p>';
        });
      }, {
        config_id: CONFIG_ID,
        response_type: 'code',
        override_default_response_type: true,
        scope: 'business_management,whatsapp_business_management,whatsapp_business_messaging,public_profile'
      });
    }
  </script>
</body>
</html>
