
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>WhatsApp Cloud API Signup Wizard</title>
  <link rel="icon" href="favicon.ico" type="image/x-icon">
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(to right, #25D366, #128C7E);
      padding: 20px;
      color: #fff;
      text-align: center;
    }
    h2 {
      color: #fff;
      margin-bottom: 20px;
    }
    button {
      padding: 12px 25px;
      background: #ffffff;
      color: #25D366;
      border: none;
      border-radius: 30px;
      cursor: pointer;
      font-size: 18px;
      font-weight: bold;
      transition: background 0.3s, color 0.3s;
    }
    button:hover {
      background: #25D366;
      color: #fff;
      border: 2px solid #fff;
    }
    .message-box {
      margin-top: 30px;
      padding: 20px;
      background: #ffffff;
      color: #333;
      border-radius: 10px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
      display: none;
    }
    .message-box a {
      color: #128C7E;
      font-weight: bold;
      text-decoration: none;
    }
    .message-box a:hover {
      text-decoration: underline;
    }
    .video-container {
      position: relative;
      padding-bottom: 56.25%; /* 16:9 aspect ratio */
      height: 0;
      overflow: hidden;
      max-width: 100%;
      background: #000;
      margin: 30px auto;
      border-radius: 10px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.3);
    }
    .video-container iframe {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      border: none;
    }
    .video-caption {
      margin: 15px 0;
      font-size: 1.2em;
      font-weight: bold;
      color: #fff;
      text-shadow: 1px 1px 3px rgba(0,0,0,0.5);
    }
    #signupDetails {
      margin-top: 15px;
      padding: 10px;
      background: #f0f8ff;
      border-radius: 5px;
      color: #333;
      font-family: monospace;
      text-align: left;
      display: none;
    }
    .copy-field {
      margin: 10px 0;
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: #f5f5f5;
      padding: 8px 12px;
      border-radius: 5px;
      font-family: monospace;
    }
    .copy-field label {
      font-weight: bold;
      margin-right: 10px;
      color: #128C7E;
    }
    .copy-field .value {
      flex-grow: 1;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    .copy-btn {
      background: #25D366;
      color: white;
      border: none;
      border-radius: 3px;
      padding: 4px 8px;
      cursor: pointer;
      margin-left: 10px;
      font-size: 12px;
    }
    .copy-btn:hover {
      background: #128C7E;
    }
        .whatsapp-widget {
            position: fixed;
            bottom: 30px;
            right: 30px;
            z-index: 9999;
            transition: all 0.3s ease;
        }
        
        .whatsapp-button {
            width: 60px;
            height: 60px;
            background-color: #25D366;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 12px rgba(37, 211, 102, 0.3);
            cursor: pointer;
            transition: all 0.3s ease;
            animation: pulse 2s infinite;
        }
        
        .whatsapp-button:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 16px rgba(37, 211, 102, 0.4);
        }
        
        .whatsapp-button img {
            width: 36px;
            height: 36px;
        }
        
        .whatsapp-tooltip {
            position: absolute;
            right: 70px;
            bottom: 15px;
            background-color: white;
            color: #333;
            padding: 8px 12px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            font-size: 14px;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
            width: 0;
            white-space: nowrap;
            overflow: hidden;
        }
        
        .whatsapp-button:hover + .whatsapp-tooltip {
            opacity: 1;
            visibility: visible;
            width: auto;
            padding: 8px 12px;
        }
        
        @keyframes pulse {
            0% {
                box-shadow: 0 0 0 0 rgba(37, 211, 102, 0.7);
            }
            70% {
                box-shadow: 0 0 0 10px rgba(37, 211, 102, 0);
            }
            100% {
                box-shadow: 0 0 0 0 rgba(37, 211, 102, 0);
            }
        }
        
        @media (max-width: 768px) {
            .whatsapp-widget {
                bottom: 20px;
                right: 20px;
            }
            
            .whatsapp-button {
                width: 50px;
                height: 50px;
            }
            
            .whatsapp-button img {
                width: 30px;
                height: 30px;
            }
        }
  </style>
</head>
<body>

<h2>WhatsApp Cloud API Signup Wizard</h2>
<div>
<p style="text-align: center; line-height: 1.0;">
  Kya aapka WhatsApp Business account bar bar ban ho raha hai? üò∞<br><br>
  Zyada chats handle karte karte system band ho jata hai?<br>
  Aur aap har message ka jawab manually dete dete thak chuke hain?<br><br>
  Ab tension khatam!<br><br>
  ‚úÖ SRLines ‚Äì Pakistan ka pehla Meta Verified Tech Provider<br>
  üéâ Ab Cloud API chalayen apne existing WhatsApp number par!<br><br>
  üß† Hamara CRM ab aur bhi powerful hai:<br>
  ‚û° Inbound messages par tags aur comments lagayen<br>
  ‚û° Conversations assign karein agents ko ‚Äì taake koi lead miss na ho!<br><br>
  Apni automation khud setup karein:<br>
  üåê cloudapi.srlines.net<br>
  üõ† 10 din bilkul FREE!<br><br>
  Apni chats ka future secure karein ‚Äì abhi start karein!
</p>  
</div>
<button data-facebook-login-btn class="facebook-login-btn">Start WhatsApp Setup Wizard</button>

<div id="successMessage" class="message-box">
  <h3>üéâ Congratulations!</h3>
  <p>Your WhatsApp Cloud API credentials:</p>
  
  <div class="copy-field">
    <label>WhatsApp business account ID:</label>
    <span class="value" id="waba-id-field">$waba_id</span>
    <button class="copy-btn" onclick="copyToClipboard('waba-id-field')">Copy</button>
  </div>
  
  <div id="signupDetails"></div>
  <p>As the next step, please visit: <br>
    <a href="https://crm.srlines.net/user" target="_blank">https://crm.srlines.net/user</a><br>
    to Signup/Login and enter above credentials into respective fields.</p>
</div>

<div class="video-caption">Still confused how to create WhatsApp Cloud API account? Watch this Video.</div>
<div class="video-container">
<iframe width="560" height="315"
    src="https://www.youtube.com/embed/c3Lch84AEds"
    frameborder="0"
    allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
    allowfullscreen>
</iframe>
  <br /><br /><br />
</div>
  
<script src="https://connect.facebook.net/en_US/sdk.js"></script>
<script>
window.addEventListener("message", sessionInfoListener);
const button = document.querySelector("[data-facebook-login-btn]");
button.addEventListener("click", launchWhatsAppSignup);

function sessionInfoListener(event) {
    // First check if the origin is facebook.com
    if (event.origin !== "https://www.facebook.com") return;
    
    try {
        console.log("event.data", event.data);
        const data = typeof event.data === 'string' ? JSON.parse(event.data) : event.data;
        const { phone_number_id, waba_id, business_id } = data.data;
        console.log(`Phone number ID: ${phone_number_id}, WABA ID: ${waba_id}, Business ID: ${business_id}`);        
        if (waba_id) {
            // Update the field
            document.getElementById('waba-id-field').textContent = waba_id;
                
            // Show the success message
            const successMessage = document.getElementById('successMessage');
            successMessage.style.display = 'block';
            successMessage.scrollIntoView({ behavior: 'smooth' });
                
            // Also show the signup details if needed
            document.getElementById('signupDetails').style.display = 'block';
        }
    } catch (e) {
        console.log("Error processing message:", e);
        console.log("Non JSON Response", event.data);
    }
}

function copyToClipboard(elementId) {
    const element = document.getElementById(elementId);
    const text = element.textContent;
    navigator.clipboard.writeText(text).then(() => {
        const btn = element.nextElementSibling;
        btn.textContent = 'Copied!';
        setTimeout(() => {
            btn.textContent = 'Copy';
        }, 2000);
    }).catch(err => {
        console.error('Failed to copy: ', err);
    });
}

window.fbAsyncInit = function () {
    FB.init({
        appId: "6673587296096434",
        xfbml: false,
        version: "v23.0",
        cookie: true,
        status: true
    });
};

function signupResponseCallback(response) {
    console.log("response", response);
    if (response.authResponse) {
        const code = response.authResponse.code;
        console.log("auth code", code);
    } else {
        console.log("User cancelled login or did not fully authorize.");
    }
}

function launchWhatsAppSignup() {
    FB.login(signupResponseCallback, {
        config_id: "1148059857348036",
        response_type: "code",
        override_default_response_type: true,
        extras: {
            setup: {},
            featureType: "whatsapp_business_app_onboarding",
            sessionInfoVersion: "3"
        },
        scope: "business_management,whatsapp_business_management,whatsapp_business_messaging,public_profile"
    });
}
</script>
    <!-- Facebook Pixel Code -->
    <script>
        !function(f,b,e,v,n,t,s)
        {if(f.fbq)return;n=f.fbq=function(){n.callMethod?
        n.callMethod.apply(n,arguments):n.queue.push(arguments)};
        if(!f._fbq)f._fbq=n;n.push=n;n.loaded=!0;n.version='2.0';
        n.queue=[];t=b.createElement(e);t.async=!0;
        t.src=v;s=b.getElementsByTagName(e)[0];
        s.parentNode.insertBefore(t,s)}(window, document,'script',
        'https://connect.facebook.net/en_US/fbevents.js');
        fbq('init', '1426121475492328');
        fbq('track', 'PageView');
        fbq('track', 'ViewContent');
    </script>
    <noscript><img height="1" width="1" style="display:none"
        src="https://www.facebook.com/tr?id=1426121475492328&ev=PageView&noscript=1"
        src="https://www.facebook.com/tr?id=1426121475492328&ev=ViewContent&noscript=1"
    /></noscript>
    <!-- End Facebook Pixel Code -->
    
    <script>    
        // Meta Conversion API - PageView Event Handler
        const handleMetaPageViewEvent = async (pageData) => {
            try {
                // Construct payload
                const payload = {
                    pixelId: '1426121475492328',
                    accessToken: 'EAALwBZBVJSZAgBO42LMioKD7dZB17ENvRFPONEflZCpNBVoZB6kdtaLkeWLLtjqd3vNsHS68CqCcd2KZBuglaoNGZA8Pi0Wdp1fqDOE60NFbN1dnSsb68vsZCfLf4AcWjevSHnOmstgtrcGb5HpjJ4DSrz3mh6OY748XniJ9rrODCZCz3vj5ZCfmodnvN2blI32Qzg5QZDZD',
                    eventName: 'PageView',
                    eventId: `page_${Date.now()}_${Math.random().toString(36).slice(2, 6)}`,
                    eventSourceUrl: window.location.href,
                    userData: {
                        client_user_agent: navigator.userAgent,
                        client_ip_address: await fetch('https://api.ipify.org?format=json')
                            .then(res => res.json()).then(data => data.ip).catch(() => ''),
                        fbc: getFbcCookie(),
                        fbp: getFbpCookie()    
                    },
                    customData: {
                        page_title: pageData?.title || document.title,
                        page_url: window.location.href,
                        page_type: pageData?.type || 'unknown'
                    }
                };

                // Send to Cloud Function
                const response = await fetch(
                    'https://us-central1-onex-time-plus-static-website.cloudfunctions.net/sendMetaEvent',
                    {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    }
                );

                if (!response.ok) throw new Error(await response.text());
                return await response.json();

            } catch (error) {
                console.error('PageView Error:', error);
                throw error;
            }
        };

        // Meta Conversion API - ViewContent Event Handler
        const handleMetaViewContentEvent = async (productData) => {
            try {
                // Construct payload
                const payload = {
                    pixelId: '1426121475492328',
                    accessToken: 'EAALwBZBVJSZAgBO42LMioKD7dZB17ENvRFPONEflZCpNBVoZB6kdtaLkeWLLtjqd3vNsHS68CqCcd2KZBuglaoNGZA8Pi0Wdp1fqDOE60NFbN1dnSsb68vsZCfLf4AcWjevSHnOmstgtrcGb5HpjJ4DSrz3mh6OY748XniJ9rrODCZCz3vj5ZCfmodnvN2blI32Qzg5QZDZD',
                    eventName: 'ViewContent',
                    eventId: `view_${Date.now()}_${Math.random().toString(36).slice(2, 6)}`,
                    eventSourceUrl: window.location.href,
                    userData: {
                        client_user_agent: navigator.userAgent,
                        client_ip_address: await fetch('https://api.ipify.org?format=json')
                            .then(res => res.json()).then(data => data.ip).catch(() => ''),
                        fbc: getFbcCookie(),
                        fbp: getFbpCookie()    
                    },
                    customData: {
                        content_ids: 'ecomm-service',
                        content_name: 'ecomm-service',
                        content_type: 'ecomm-service',
                        currency: 'PKR',
                        value: '1999'
                    }
                };

                // Send to Cloud Function
                const response = await fetch(
                    'https://us-central1-onex-time-plus-static-website.cloudfunctions.net/sendMetaEvent',
                    {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    }
                );

                if (!response.ok) throw new Error(await response.text());
                return await response.json();

            } catch (error) {
                console.error('ViewContent Error:', error);
                throw error;
            }
        };

        function getFbcCookie() {
            // Match the _fbc cookie
            const match = document.cookie.match(/_fbc=([^;]+)/);
            if (!match) return undefined;
            
            const fbcValue = match[1];
            
            // Updated validation pattern for fbcPattern
            const fbcPattern = /^fb\.([0-9]+)\.([0-9]+)(\.[0-9]+)?(\.[a-zA-Z0-9_\-]+)*$/i;
            
            if (!fbcPattern.test(fbcValue)) {
                console.warn('Invalid FBC format detected:', fbcValue);
                return undefined;
            }
            
            // Extract timestamp (second segment)
            const segments = fbcValue.split('.');
            const timestamp = parseInt(segments[2]);
            
            // Check if timestamp is within 24 hours
            const twentyFourHoursAgo = Date.now() - (24 * 60 * 60 * 1000);
            if (timestamp < twentyFourHoursAgo / 1000) {
                console.warn('Expired FBC value (older than 24 hours):', fbcValue);
                return undefined;
            }
            
            return fbcValue;
        }

        function getFbpCookie() {
            const match = document.cookie.match(/_fbp=([^;]+)/);
            return match ? match[1] : undefined;
        }
        
        // Initialize the page
        document.addEventListener('DOMContentLoaded', () => {
            
            // Call Meta event handlers
            const metaResponsePageViewEvent = handleMetaPageViewEvent({
                title: '',
                type: 'product_page'
            }).then(response => {
                console.log('PageView event successful:', response);
            }).catch(error => {
            console.error('PageView event failed:', error);
            });
            
            const metaResponseViewContentEvent = handleMetaViewContentEvent({
                productId: '',
                price: '',
                name: ''
            }).then(response => {
                console.log('ViewContent event successful:', response);
            }).catch(error => {
            console.error('ViewContent event failed:', error);
            });
        });
    </script>    
    <div class="whatsapp-widget">
        <a href="https://wa.me/923283897926?text=Hi" class="whatsapp-button" target="_blank" rel="noopener noreferrer">
            <img src="https://upload.wikimedia.org/wikipedia/commons/6/6b/WhatsApp.svg" alt="WhatsApp">
        </a>
        <div class="whatsapp-tooltip">Chat with us on WhatsApp</div>
    </div>        
</body>
</html>
