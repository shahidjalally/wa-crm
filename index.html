<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>WhatsApp Cloud API Signup Wizard</title>
  <link rel="icon" href="favicon.ico" type="image/x-icon">
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(to right, #25D366, #128C7E);
      padding: 20px;
      color: #fff;
      text-align: center;
    }
    h2 {
      color: #fff;
      margin-bottom: 20px;
    }
    button {
      padding: 12px 25px;
      background: #ffffff;
      color: #25D366;
      border: none;
      border-radius: 30px;
      cursor: pointer;
      font-size: 18px;
      font-weight: bold;
      transition: background 0.3s, color 0.3s;
    }
    button:hover {
      background: #25D366;
      color: #fff;
      border: 2px solid #fff;
    }
    .message-box {
      margin-top: 30px;
      padding: 20px;
      background: #ffffff;
      color: #333;
      border-radius: 10px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
      display: none;
    }
    .message-box a {
      color: #128C7E;
      font-weight: bold;
      text-decoration: none;
    }
    .message-box a:hover {
      text-decoration: underline;
    }
    .video-container {
      position: relative;
      padding-bottom: 56.25%; /* 16:9 aspect ratio */
      height: 0;
      overflow: hidden;
      max-width: 100%;
      background: #000;
      margin: 30px auto;
      border-radius: 10px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.3);
    }
    .video-container iframe {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      border: none;
    }
    .video-caption {
      margin: 15px 0;
      font-size: 1.2em;
      font-weight: bold;
      color: #fff;
      text-shadow: 1px 1px 3px rgba(0,0,0,0.5);
    }
    #signupDetails {
      margin-top: 15px;
      padding: 10px;
      background: #f0f8ff;
      border-radius: 5px;
      color: #333;
      font-family: monospace;
      text-align: left;
      display: none;
    }
    .copy-field {
      margin: 10px 0;
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: #f5f5f5;
      padding: 8px 12px;
      border-radius: 5px;
      font-family: monospace;
    }
    .copy-field label {
      font-weight: bold;
      margin-right: 10px;
      color: #128C7E;
    }
    .copy-field .value {
      flex-grow: 1;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    .copy-btn {
      background: #25D366;
      color: white;
      border: none;
      border-radius: 3px;
      padding: 4px 8px;
      cursor: pointer;
      margin-left: 10px;
      font-size: 12px;
    }
    .copy-btn:hover {
      background: #128C7E;
    }
  </style>
</head>
<body>

<h2>WhatsApp Cloud API Signup Wizard</h2>

<button data-facebook-login-btn class="facebook-login-btn">Start WhatsApp Setup Wizard</button>

<div id="successMessage" class="message-box">
  <h3>ðŸŽ‰ Congratulations!</h3>
  <p>Your WhatsApp Cloud API credentials:</p>
  
  <div class="copy-field">
    <label>WhatsApp business account ID:</label>
    <span class="value" id="waba-id-field">$waba_id</span>
    <button class="copy-btn" onclick="copyToClipboard('waba-id-field')">Copy</button>
  </div>
  
  <div class="copy-field">
    <label>Business Account ID:</label>
    <span class="value" id="business-id-field">$business_id</span>
    <button class="copy-btn" onclick="copyToClipboard('business-id-field')">Copy</button>
  </div>
  
  <div class="copy-field">
    <label>WhatsApp phone ID:</label>
    <span class="value" id="phone-id-field">$phone_number_id</span>
    <button class="copy-btn" onclick="copyToClipboard('phone-id-field')">Copy</button>
  </div>
  
  <div id="signupDetails"></div>
  <p>As the next step, please visit: <br>
    <a href="https://crm.srlines.net/user" target="_blank">https://crm.srlines.net/user</a><br>
    to Signup/Login and enter above credentials into respective fields.</p>
</div>


<div class="video-caption">How to Create WhatsApp Cloud API Account in 5 Minutes</div>
<div class="video-container">
  <iframe src="https://www.youtube.com/embed/c0xi7QWOnTM" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
</div>
  
<script src="https://connect.facebook.net/en_US/sdk.js"></script>
<script>
window.addEventListener("message", sessionInfoListener);
const button = document.querySelector("[data-facebook-login-btn]");
button.addEventListener("click", launchWhatsAppSignup);

function sessionInfoListener(event) {
    if (event.origin !== "https://www.facebook.com") return;
    try {
        console.log("event.data", event.data);
        const data = JSON.parse(event.data);
        if (data.type === "WA_EMBEDDED_SIGNUP") {
            if (data.event === "FINISH") {
                const { phone_number_id, waba_id, business_id } = data.data;
                console.log(`Phone number ID: ${phone_number_id}, WABA ID: ${waba_id}, Business ID: ${business_id}`);
                document.getElementById('waba-id-field').textContent = waba_id;
                document.getElementById('business-id-field').textContent = business_id;
                document.getElementById('phone-id-field').textContent = phone_number_id;
                document.getElementById('successMessage').style.display = 'block';
            }
            else {
                const { current_step } = data.data;
                console.log(`Cancelled at step: ${current_step}`);
            }
        }
    } catch {
        console.log("Non JSON Response", event.data);
    }
}

function copyToClipboard(elementId) {
    const element = document.getElementById(elementId);
    const text = element.textContent;
    navigator.clipboard.writeText(text).then(() => {
        const btn = element.nextElementSibling;
        btn.textContent = 'Copied!';
        setTimeout(() => {
            btn.textContent = 'Copy';
        }, 2000);
    }).catch(err => {
        console.error('Failed to copy: ', err);
    });
}

window.fbAsyncInit = function () {
    FB.init({
        appId: "6673587296096434",
        xfbml: false,
        version: "v23.0",
        cookie: true,
        status: true
    });
};

function signupResponseCallback(response) {
    console.log("response", response);
    if (response.authResponse) {
        const code = response.authResponse.code;
        console.log("auth code", code);
    } else {
        console.log("User cancelled login or did not fully authorize.");
    }
}

function launchWhatsAppSignup() {
    FB.login(signupResponseCallback, {
        config_id: "1148059857348036",
        response_type: "code",
        override_default_response_type: true,
        extras: {
            setup: {},
            featureType: "whatsapp_business_app_onboarding",
            sessionInfoVersion: "3"
        },
        scope: "business_management,whatsapp_business_management,whatsapp_business_messaging,public_profile"
    });
}
</script>
    <!-- Facebook Pixel Code -->
    <script>
        !function(f,b,e,v,n,t,s)
        {if(f.fbq)return;n=f.fbq=function(){n.callMethod?
        n.callMethod.apply(n,arguments):n.queue.push(arguments)};
        if(!f._fbq)f._fbq=n;n.push=n;n.loaded=!0;n.version='2.0';
        n.queue=[];t=b.createElement(e);t.async=!0;
        t.src=v;s=b.getElementsByTagName(e)[0];
        s.parentNode.insertBefore(t,s)}(window, document,'script',
        'https://connect.facebook.net/en_US/fbevents.js');
        fbq('init', '1426121475492328');
        fbq('track', 'PageView');
        fbq('track', 'ViewContent');
    </script>
    <noscript><img height="1" width="1" style="display:none"
        src="https://www.facebook.com/tr?id=1426121475492328&ev=PageView&noscript=1"
        src="https://www.facebook.com/tr?id=1426121475492328&ev=ViewContent&noscript=1"
    /></noscript>
    <!-- End Facebook Pixel Code -->
    
    <script>    
        // Meta Conversion API - PageView Event Handler
        const handleMetaPageViewEvent = async (pageData) => {
            try {
                // Construct payload
                const payload = {
                    pixelId: '1426121475492328',
                    accessToken: 'EAALwBZBVJSZAgBO42LMioKD7dZB17ENvRFPONEflZCpNBVoZB6kdtaLkeWLLtjqd3vNsHS68CqCcd2KZBuglaoNGZA8Pi0Wdp1fqDOE60NFbN1dnSsb68vsZCfLf4AcWjevSHnOmstgtrcGb5HpjJ4DSrz3mh6OY748XniJ9rrODCZCz3vj5ZCfmodnvN2blI32Qzg5QZDZD',
                    eventName: 'PageView',
                    eventId: `page_${Date.now()}_${Math.random().toString(36).slice(2, 6)}`,
                    eventSourceUrl: window.location.href,
                    userData: {
                        client_user_agent: navigator.userAgent,
                        client_ip_address: await fetch('https://api.ipify.org?format=json')
                            .then(res => res.json()).then(data => data.ip).catch(() => ''),
                        fbc: getFbcCookie(),
                        fbp: getFbpCookie()    
                    },
                    customData: {
                        page_title: pageData?.title || document.title,
                        page_url: window.location.href,
                        page_type: pageData?.type || 'unknown'
                    }
                };

                // Send to Cloud Function
                const response = await fetch(
                    'https://us-central1-onex-time-plus-static-website.cloudfunctions.net/sendMetaEvent',
                    {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    }
                );

                if (!response.ok) throw new Error(await response.text());
                return await response.json();

            } catch (error) {
                console.error('PageView Error:', error);
                throw error;
            }
        };

        // Meta Conversion API - ViewContent Event Handler
        const handleMetaViewContentEvent = async (productData) => {
            try {
                // Construct payload
                const payload = {
                    pixelId: '1426121475492328',
                    accessToken: 'EAALwBZBVJSZAgBO42LMioKD7dZB17ENvRFPONEflZCpNBVoZB6kdtaLkeWLLtjqd3vNsHS68CqCcd2KZBuglaoNGZA8Pi0Wdp1fqDOE60NFbN1dnSsb68vsZCfLf4AcWjevSHnOmstgtrcGb5HpjJ4DSrz3mh6OY748XniJ9rrODCZCz3vj5ZCfmodnvN2blI32Qzg5QZDZD',
                    eventName: 'ViewContent',
                    eventId: `view_${Date.now()}_${Math.random().toString(36).slice(2, 6)}`,
                    eventSourceUrl: window.location.href,
                    userData: {
                        client_user_agent: navigator.userAgent,
                        client_ip_address: await fetch('https://api.ipify.org?format=json')
                            .then(res => res.json()).then(data => data.ip).catch(() => ''),
                        fbc: getFbcCookie(),
                        fbp: getFbpCookie()    
                    },
                    customData: {
                        content_ids: 'ecomm-service',
                        content_name: 'ecomm-service',
                        content_type: 'ecomm-service',
                        currency: 'PKR',
                        value: '1999'
                    }
                };

                // Send to Cloud Function
                const response = await fetch(
                    'https://us-central1-onex-time-plus-static-website.cloudfunctions.net/sendMetaEvent',
                    {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    }
                );

                if (!response.ok) throw new Error(await response.text());
                return await response.json();

            } catch (error) {
                console.error('ViewContent Error:', error);
                throw error;
            }
        };

        function getFbcCookie() {
            // Match the _fbc cookie
            const match = document.cookie.match(/_fbc=([^;]+)/);
            if (!match) return undefined;
            
            const fbcValue = match[1];
            
            // Updated validation pattern for fbcPattern
            const fbcPattern = /^fb\.([0-9]+)\.([0-9]+)(\.[0-9]+)?(\.[a-zA-Z0-9_\-]+)*$/i;
            
            if (!fbcPattern.test(fbcValue)) {
                console.warn('Invalid FBC format detected:', fbcValue);
                return undefined;
            }
            
            // Extract timestamp (second segment)
            const segments = fbcValue.split('.');
            const timestamp = parseInt(segments[2]);
            
            // Check if timestamp is within 24 hours
            const twentyFourHoursAgo = Date.now() - (24 * 60 * 60 * 1000);
            if (timestamp < twentyFourHoursAgo / 1000) {
                console.warn('Expired FBC value (older than 24 hours):', fbcValue);
                return undefined;
            }
            
            return fbcValue;
        }

        function getFbpCookie() {
            const match = document.cookie.match(/_fbp=([^;]+)/);
            return match ? match[1] : undefined;
        }
        
        // Initialize the page
        document.addEventListener('DOMContentLoaded', () => {
            
            // Call Meta event handlers
            const metaResponsePageViewEvent = handleMetaPageViewEvent({
                title: '',
                type: 'product_page'
            }).then(response => {
                console.log('PageView event successful:', response);
            }).catch(error => {
            console.error('PageView event failed:', error);
            });
            
            const metaResponseViewContentEvent = handleMetaViewContentEvent({
                productId: '',
                price: '',
                name: ''
            }).then(response => {
                console.log('ViewContent event successful:', response);
            }).catch(error => {
            console.error('ViewContent event failed:', error);
            });
        });
    </script>    
<!-- WhatsApp Chat Support Widget (Advanced Version) -->
<a href="https://wa.me/923283897926?text=Hi" 
   target="_blank" 
   id="whatsapp-chat-widget">
    <span class="chat-text">Humaray Sath Rabta Karen!</span>
    <div class="icon-pulse">
      <img src="https://upload.wikimedia.org/wikipedia/commons/6/6b/WhatsApp.svg" alt="Chat on WhatsApp">
    </div>
</a>

<style>
  #whatsapp-chat-widget {
    position: fixed;
    bottom: 20px;
    right: 20px;
    z-index: 9999;
    display: flex;
    align-items: center;
    text-decoration: none;
    font-family: Arial, sans-serif;
  }

  .chat-text {
    margin-right: 10px;
    background-color: #25D366;
    color: white;
    padding: 8px 14px;
    border-radius: 20px;
    font-size: 14px;
    white-space: nowrap;
    box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    transition: all 0.3s ease;
  }

  .icon-pulse {
    position: relative;
    width: 60px;
    height: 60px;
  }

  .icon-pulse::before {
    content: "";
    position: absolute;
    top: 0; left: 0;
    width: 100%; height: 100%;
    border-radius: 50%;
    background-color: rgba(37, 211, 102, 0.5);
    animation: pulse 1.5s infinite;
    z-index: 1;
  }

  .icon-pulse img {
    width: 60px;
    height: 60px;
    border-radius: 50%;
    padding: 10px;
    background-color: #25D366;
    box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    position: relative;
    z-index: 2;
  }

  @keyframes pulse {
    0% {
      transform: scale(1);
      opacity: 0.7;
    }
    50% {
      transform: scale(1.4);
      opacity: 0;
    }
    100% {
      transform: scale(1);
      opacity: 0.7;
    }
  }
</style>
</body>
</html>
